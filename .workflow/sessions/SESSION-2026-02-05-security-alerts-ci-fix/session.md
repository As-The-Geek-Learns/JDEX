# Session: Security Alerts — CI Fix & Final Push

**Session ID:** SESSION-2026-02-05-security-alerts-ci-fix
**Date:** 2026-02-05
**Branch:** `fix/security-alerts`
**PR:** #19 (As-The-Geek-Learns/jdex-premium)
**Phase:** Execute → Verify → **CI Green**
**Continues:** SESSION-2026-02-04-security-audit-and-deps

---

## Overview

Continuation session to get PR #19 through CI. The previous session (Feb 4) made all the security fixes but CI was failing on the "Check formatting" step. This session diagnosed the failures, committed formatting fixes, strengthened one of the security fixes, and resolved a subtle auto-generated file issue that was the final CI blocker.

---

## Tasks Completed

| # | Description | Status | Notes |
|---|-------------|--------|-------|
| 1 | Commit Prettier formatting fixes (34 files) | Done | Pre-existing drift, not from our changes |
| 2 | Pin 3rd-party action SHAs in ci.yml | Done | semgrep-action + gitleaks-action |
| 3 | Strengthen HTML sanitization in validation.js | Done | Replaced loop-regex with character removal |
| 4 | Diagnose CI formatting failure | Done | verify-state.json missing trailing newline |
| 5 | Add .workflow/ to .prettierignore | Done | Excludes auto-generated state files |
| 6 | Verify all 5 CI jobs pass | Done | Quality, Security, Semgrep, Gitleaks, Build |

---

## Commits Made

### Commit 1: `19ef0bd`
**Message:** `style: apply Prettier formatting across codebase`
**Files:** 34 app source files (components, services, contexts, utils, electron)
**Why:** Prettier formatting had drifted across the codebase. CI runs `prettier --check .` and was failing on files unrelated to our security changes. Had to fix these first to unblock CI.

### Commit 2: `db7422c`
**Message:** `fix(security): pin 3rd-party actions and fix HTML sanitization`
**Files:** `.github/workflows/ci.yml`, `app/src/utils/validation.js`
**Changes:**
- Pinned `returntocorp/semgrep-action` to `713efdd...` (resolves CodeQL #6)
- Pinned `gitleaks/gitleaks-action` to `ff98106...` (resolves CodeQL #7)
- Replaced `stripHtmlTags()` with `stripHtmlChars()` (resolves CodeQL #9, #10)

### Commit 3: `c4d403a`
**Message:** `fix: exclude .workflow/ from Prettier formatting checks`
**Files:** `app/.prettierignore`
**Why:** Auto-generated `verify-state.json` was committed without trailing newline, causing CI failure.

---

## Key Decisions

### 1. Character removal vs. tag-matching regex (validation.js)

**Context:** The Feb 4 session replaced single-pass `/<[^>]*>/g` with a loop-until-stable version of the same regex. CodeQL still flagged this as "incomplete multi-character sanitization" because `/<[^>]*>/g` fundamentally can't match malformed tags like `<script` (no closing `>`).

**Decision:** Replace the entire approach. Instead of trying to match and remove HTML tags (which regex can never fully handle), remove the individual `<` and `>` characters entirely with `/[<>]/g`.

**Tradeoffs:**
- Pro: Eliminates ALL possible HTML injection, including malformed tags
- Pro: Simpler code — one line instead of a loop
- Pro: Resolves CodeQL alert definitively
- Con: Strips legitimate angle brackets from text (acceptable for this app's use cases — JD folder names and descriptions don't need `<` or `>`)

**Renamed:** `stripHtmlTags` → `stripHtmlChars` to reflect the new behavior.

### 2. SHA pinning for GitHub Actions

**Context:** CodeQL alerts #6 and #7 flagged `@v1` and `@v2` tags on `returntocorp/semgrep-action` and `gitleaks/gitleaks-action` as unpinned tags.

**Decision:** Pin to full commit SHAs with version comment:
```yaml
uses: returntocorp/semgrep-action@713efdd345f3035192eaa63f56867b88e63e4e5d # v1
uses: gitleaks/gitleaks-action@ff98106e4c7b2bc287b24eaf42907196329070c7 # v2
```

**Why:** Mutable tags can be force-pushed to point at different code. SHA pinning ensures reproducible, tamper-resistant builds. The `# v1` comment preserves human readability.

### 3. Exclude .workflow/ from Prettier

**Context:** `app/.workflow/state/verify-state.json` is auto-generated by `scripts/verify.js`. It was committed without a trailing newline, which Prettier requires for JSON files.

**Decision:** Add `.workflow/` to `app/.prettierignore` rather than reformatting the file.

**Why:** This is machine-generated state data. Formatting it is pointless and creates friction — every time `verify.js` regenerates the file, it would need to be re-formatted before committing. Better to exclude the entire directory.

---

## Issues Encountered

### Issue 1: CI/Local Prettier Mismatch

**Problem:** CI failed on "Check formatting" but local `npx prettier --check .` passed.

**Root Cause:** The committed version of `verify-state.json` had no trailing newline (`\ No newline at end of file` in git diff), but the local working copy had one added by a text editor. Prettier checks the committed files in CI but the working copy locally.

**Diagnosis:** Pulled CI logs via `gh run view --log`, which showed the single offending file: `.workflow/state/verify-state.json`.

**Fix:** Added `.workflow/` to `.prettierignore`.

**Lesson:** When CI formatting checks fail but local checks pass, always check for differences between committed and working-copy versions, especially for auto-generated files.

### Issue 2: Wrong Git Remote Name

**Problem:** `git push premium fix/security-alerts` failed — no "premium" remote.

**Root Cause:** This repo clone only has `origin` pointing to jdex-premium (the CLAUDE.md mentions dual remotes but this clone doesn't have both configured).

**Fix:** Used `git push origin fix/security-alerts` instead.

---

## CI Results (Final Run)

**Run:** [21713955464](https://github.com/As-The-Geek-Learns/jdex-premium/actions/runs/21713955464)

| Job | Status | Duration |
|-----|--------|----------|
| Code Quality (ESLint + Prettier) | Pass | 32s |
| Security Scan (npm audit) | Pass | 27s |
| Security Scan (Semgrep) | Pass | 28s |
| Secrets Scan (Gitleaks) | Pass | 6s |
| Build (Vite) | Pass | 33s |

**Annotations:** 10 ESLint warnings for unused imports in App.jsx and electron files — pre-existing structural debt, not related to this PR.

---

## Alert Status After Merge

### Will Auto-Close (CodeQL re-scan)

| Alert | Rule | Resolution |
|-------|------|------------|
| #1-5 | missing-workflow-permissions | `permissions: contents: read` (Feb 4 commit) |
| #6-7 | unpinned-tag | SHA-pinned semgrep + gitleaks actions |
| #8 | insecure-randomness | `crypto.randomUUID`/`getRandomValues` (Feb 4 commit) |
| #9-10 | incomplete-multi-character-sanitization | Character-level `<>` removal |
| #11 | incomplete-sanitization | `--body-file` temp file pattern (Feb 4 commit) |
| #12-13 | indirect-command-line-injection | `execFileSync` + `validateGitRef` (Feb 4 commit) |

### Require Manual Dismissal

| Alert | Rule | Justification |
|-------|------|---------------|
| #14 | http-to-file-access | Expected: verify.js writes local state |
| #15 | file-access-to-http | Expected: sends code to Gemini for review |
| #16, #18 | log-injection | CLI tool, not web-facing |
| #17 | log-injection | CLI tool, not web-facing |

### Dependabot (Separate)

| Alert | Package | Severity | Status |
|-------|---------|----------|--------|
| #7 | brace-expansion | HIGH | Fixed in package-lock.json |
| #4, #6 | tar | HIGH | Fixed in package-lock.json |
| #2 | electron (ASAR bypass) | MODERATE | Deferred — needs major upgrade 28 → 35+ |

---

## ASTGL Content Moments

1. **[ASTGL CONTENT] The Trailing Newline Trap** — Auto-generated JSON files committed without trailing newlines can cause CI formatting checks to fail while local checks pass. The local working copy silently gets the newline added by editors/tools, masking the issue. Fix: exclude machine-generated files from formatting via `.prettierignore`. This is a great "invisible bug" teaching moment.

2. **[ASTGL CONTENT] Why Character Removal Beats Tag Matching** — HTML sanitization via regex tag matching (`/<[^>]*>/g`) is fundamentally incomplete because regex can't handle malformed HTML like `<script` (no closing bracket). Removing `<` and `>` characters entirely is simpler, more secure, and eliminates the entire attack surface. Sometimes the "dumber" solution is the right one.

3. **[ASTGL CONTENT] SHA Pinning GitHub Actions** — Using `@v1` tags for third-party actions is a supply chain risk — tags are mutable and can be force-pushed. Pin to full commit SHAs with version comments for reproducible, tamper-resistant CI. Look up SHAs with `gh api repos/OWNER/REPO/git/ref/tags/TAG`.

---

## Next Steps

1. **Merge PR #19** — CI is green, ready for review
2. **Dismiss alerts #14-18** via GitHub Security tab (delegated dismissal required)
3. **Monitor CodeQL re-scan** — verify alerts #1-13 auto-close after merge
4. **Plan Electron upgrade** (28 → 35+) as separate work item
5. **Continue cross-org alert remediation** — substack-scheduler has a CRITICAL SSRF alert

---

## Session Stats

- **Duration:** ~1 hour (continuation from Feb 4 session)
- **Commits:** 3
- **Files changed:** 36 (34 formatting + ci.yml + validation.js + .prettierignore)
- **CI runs:** 3 (2 failed, 1 passed)
- **Alerts resolved:** 13 CodeQL (will close on merge) + 3 Dependabot (will close on merge)
